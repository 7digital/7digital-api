<!DOCTYPE html>

<html>
<head>
  <title>request.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>request.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="create-user.html">
                    create-user.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="customconfig.html">
                    customconfig.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="default-action.html">
                    default-action.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="oauth.html">
                    oauth.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="simpleclient.html">
                    simpleclient.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="trackpreview.html">
                    trackpreview.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="two-legged.html">
                    two-legged.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="actionhelper.html">
                    actionhelper.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="api.html">
                    api.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="cache.html">
                    cache.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="cleaners.html">
                    cleaners.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="errors.html">
                    errors.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="helpers.html">
                    helpers.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="noop-cache.html">
                    noop-cache.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="oauth.html">
                    oauth.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="request.html">
                    request.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="resource.html">
                    resource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="responseparser.html">
                    responseparser.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> actionhelper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./actionhelper'</span>);
<span class="hljs-keyword">var</span> ApiHttpError = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./errors'</span>).ApiHttpError;
<span class="hljs-keyword">var</span> cache = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./cache'</span>);
<span class="hljs-keyword">var</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> helpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers'</span>);
<span class="hljs-keyword">var</span> oauthHelper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./oauth'</span>);
<span class="hljs-keyword">var</span> USER_AGENT = <span class="hljs-string">'Node.js HTTP Client'</span>;</pre></div>
        
      
        
        <p>Formats request parameters as expected by the API.</p>
<ul>
<li>@param {Object} data - hash of pararameters</li>
<li>@param {String} consumerkey - consumer key</li>
<li>@return {String} - Encoded parameter string</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare</span><span class="hljs-params">(data, consumerkey)</span> </span>{
	<span class="hljs-keyword">var</span> prop;
	data = data || {};

	<span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> data) {
		<span class="hljs-keyword">if</span> (data.hasOwnProperty(prop)) {
			<span class="hljs-keyword">if</span> (_.isDate(data[prop])) {
				data[prop] = helpers.toYYYYMMDD(data[prop]);
			}
		}
	}

	data.oauth_consumer_key = consumerkey;

	<span class="hljs-keyword">return</span> data;
}</pre></div>
        
      
        
        <p>Generates the default request headers</p>
<ul>
<li>@return {Object}</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createHeaders</span><span class="hljs-params">(host, headers)</span> </span>{
	<span class="hljs-keyword">return</span> _.extend({}, headers, {
		<span class="hljs-string">'host'</span>: host,
		<span class="hljs-string">'User-Agent'</span> : USER_AGENT
	});
}</pre></div>
        
      
        
        <p>Logs out a headers hash</p>
<ul>
<li>@param {Object} logger - The logger to use</li>
<li>@param {Object} headers - The hash of headers to log</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logHeaders</span><span class="hljs-params">(logger, headers)</span> </span>{
	<span class="hljs-keyword">return</span> _.each(_.keys(headers), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
		logger.info(key + <span class="hljs-string">': '</span> + headers[key]);
	});
}</pre></div>
        
      
        
        <p>Makes a GET request to the API.</p>
<ul>
<li>@param {Object} endpointInfo - Generic metadata about the endpoint to hit.</li>
<li>@param {Object} requestData - Parameters for this specific request.</li>
<li>@param {Object} headers - Custom headers for this request.</li>
<li>@param {Object} credentials - OAuth consumerkey and consumersecret.</li>
<li>@param {Object} logger - An object implementing the npm log levels.</li>
<li>@param {Object} theCache - A response cache.</li>
<li>@param {Function} callback - The callback to call with the response.</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">(endpointInfo, requestData, headers, credentials, logger, theCache,
	callback)</span> </span>{

	<span class="hljs-keyword">var</span> normalisedData = prepare(requestData, credentials.consumerkey);
	<span class="hljs-keyword">var</span> fullUrl = endpointInfo.url + <span class="hljs-string">'?'</span> + qs.stringify(normalisedData);
	<span class="hljs-keyword">var</span> cacheKey = cache.generateCacheKeyFromUrl(fullUrl);
	<span class="hljs-keyword">var</span> hostInfo = {
		host: endpointInfo.host,
		port: endpointInfo.port
	};

	theCache.get(cacheKey, checkCacheResult);
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkCacheResult</span><span class="hljs-params">(err, cached)</span> </span>{
		<span class="hljs-keyword">var</span> cachedResponse;

		<span class="hljs-keyword">if</span> (err) {
			logger.error(<span class="hljs-string">'Error checking cache for %s'</span>, cacheKey);
			logger.error(err);
			<span class="hljs-keyword">return</span> callback(err);
		}

		<span class="hljs-keyword">if</span> (cached) {
			logger.info(<span class="hljs-string">'Cache hit for %s'</span>, cacheKey);
			<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, cached.body, { headers: cached.headers });
		}</pre></div>
        
      
        
        <p>Decide whether to make an oauth signed request or not</p>

        
          <div class='highlight'><pre>		<span class="hljs-keyword">if</span> (endpointInfo.authtype) {
			dispatchSecure(endpointInfo.url, <span class="hljs-string">'GET'</span>, requestData, headers,
				endpointInfo.authtype, hostInfo, credentials, logger,
				cacheAndCallback);
		} <span class="hljs-keyword">else</span> {
			dispatch(endpointInfo.url, <span class="hljs-string">'GET'</span>, requestData, headers, hostInfo,
				credentials, logger, cacheAndCallback);
		}

		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cacheAndCallback</span><span class="hljs-params">(err, requestData, response)</span> </span>{
			<span class="hljs-keyword">var</span> ttl, cacheObj;
			<span class="hljs-keyword">if</span> (err) {
				<span class="hljs-keyword">return</span> callback(err);
			}

			ttl = cache.parseMaxAgeHeader(response);

			<span class="hljs-keyword">if</span> (ttl) {
				cacheObj = {
					headers: response.headers,
					body: requestData
				};
				theCache.set(cacheKey, cacheObj, ttl, callbackWithResult);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, requestData, response);
			}

			<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callbackWithResult</span><span class="hljs-params">(err)</span> </span>{
				<span class="hljs-keyword">if</span> (err) {
					logger.error(<span class="hljs-string">'Error setting %s to cache'</span>, cacheKey);
					logger.error(err);
					<span class="hljs-keyword">return</span> callback(err);
				}

				logger.info(<span class="hljs-string">'Cached %s for %s seconds'</span>, cacheKey, ttl);
				<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, requestData, response);
			}
		}
	}
}</pre></div>
        
      
        
        <p>Makes a POST request to the API.</p>
<ul>
<li>@param {Object} endpointInfo - Generic metadata about the endpoint to hit.</li>
<li>@param {Object} requestData - Parameters for this specific request.</li>
<li>@param {Object} headers - Headers for this request.</li>
<li>@param {Object} credentials - OAuth consumerkey and consumersecret.</li>
<li>@param {Object} logger - An object implementing the npm log levels.</li>
<li>@param {Function} callback - The callback to call with the response.</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span><span class="hljs-params">(endpointInfo, requestData, headers, credentials, logger, callback)</span> </span>{
	<span class="hljs-keyword">var</span> hostInfo = {
		host: endpointInfo.host,
		port: endpointInfo.port
	};

	<span class="hljs-keyword">if</span> (endpointInfo.authtype) {
		dispatchSecure(endpointInfo.url, <span class="hljs-string">'POST'</span>, requestData, headers,
			endpointInfo.authtype, hostInfo, credentials, logger, callback);
	} <span class="hljs-keyword">else</span> {
		dispatch(endpointInfo.url, <span class="hljs-string">'POST'</span>, requestData, headers, hostInfo,
			credentials, logger, callback);
	}
}</pre></div>
        
      
        
        <p>Dispatches an oauth signed request to the API</p>
<ul>
<li>@param {String} url - the path of the API url to request.</li>
<li>@param {String} httpMethod</li>
<li>@param {Object} requestData - hash of the parameters for the request.</li>
<li>@param {Object} headers - Headers for this request.</li>
<li>@param {String} authType - OAuth request type: ‘2-legged’ or ‘3-legged’</li>
<li>@param {Object} hostInfo - API host information</li>
<li>@param {Function} callback - The callback to call with the response.</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchSecure</span><span class="hljs-params">(url, httpMethod, requestData, headers, authtype,
		hostInfo, credentials, logger, callback)</span> </span>{

	hostInfo.port = hostInfo.port || <span class="hljs-number">443</span>;

	<span class="hljs-keyword">var</span> is2Legged = authtype === <span class="hljs-string">'2-legged'</span>;
	<span class="hljs-keyword">var</span> token = is2Legged ? <span class="hljs-literal">null</span> : requestData.accesstoken;
	<span class="hljs-keyword">var</span> secret = is2Legged ? <span class="hljs-literal">null</span> : requestData.accesssecret;
	<span class="hljs-keyword">var</span> mergedHeaders = createHeaders(hostInfo.host, headers);
	<span class="hljs-keyword">var</span> oauthClient = oauthHelper.createOAuthWrapper(credentials.consumerkey,
			credentials.consumersecret, mergedHeaders);
	<span class="hljs-keyword">var</span> fullUrl;

	requestData = prepare(requestData, credentials.consumerkey);

	<span class="hljs-keyword">if</span> (!is2Legged) {
		<span class="hljs-keyword">delete</span> requestData.accesstoken;
		<span class="hljs-keyword">delete</span> requestData.accesssecret;
	}

	<span class="hljs-keyword">if</span> (httpMethod === <span class="hljs-string">'GET'</span>) {
		logger.info(<span class="hljs-string">'token: '</span> + token + <span class="hljs-string">' secret: '</span> + secret);

		url = actionhelper.template(url, requestData);
		fullUrl = <span class="hljs-string">'https://'</span> + hostInfo.host + <span class="hljs-string">':'</span> + hostInfo.port + url;
		fullUrl = fullUrl + <span class="hljs-string">'?'</span> + qs.stringify(requestData);
		logger.info(httpMethod + <span class="hljs-string">': '</span> + fullUrl + <span class="hljs-string">' ('</span> + authtype + <span class="hljs-string">' oauth)'</span>);
		logHeaders(logger, mergedHeaders);

		<span class="hljs-keyword">return</span> oauthClient.get(fullUrl, token, secret,
			callbackWithDataAndResponse);
	}

	<span class="hljs-keyword">if</span> (httpMethod === <span class="hljs-string">'POST'</span>) {
		fullUrl = <span class="hljs-string">'https://'</span> + hostInfo.host + <span class="hljs-string">':'</span> + hostInfo.port + url;
		logger.info(httpMethod + <span class="hljs-string">': '</span> + fullUrl + <span class="hljs-string">' ('</span> + authtype + <span class="hljs-string">' oauth)'</span>);
		logger.info(<span class="hljs-string">'DATA: '</span> + qs.stringify(requestData));
		logHeaders(logger, mergedHeaders);

		<span class="hljs-keyword">return</span> oauthClient.post(fullUrl, token, secret, requestData,
			<span class="hljs-string">'application/x-www-form-urlencoded'</span>, callbackWithDataAndResponse);
	}

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callbackWithDataAndResponse</span><span class="hljs-params">(err, data, response)</span> </span>{
		<span class="hljs-keyword">if</span> (err) {
			logger.error(err);
			<span class="hljs-keyword">return</span> callback(err);
		}

		<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, data, response);
	}

}</pre></div>
        
      
        
        <p>Dispatches requests to the API.  Serializes the data in keeping with the API
specification and applies approriate HTTP headers.</p>
<ul>
<li>@param {String} url - the URL on the API to make the request to.</li>
<li>@param {String} httpMethod</li>
<li>@param {Object} data - hash of the parameters for the request.</li>
<li>@param {Object} headers - Headers for this request.</li>
<li>@param {Object} hostInfo - hash of host, port and prefix</li>
<li>@param {Object} credentials - hash of oauth consumer key and secret</li>
<li>@param {Object} logger - an object implementing the npm log levels</li>
<li>@param {Function} callback</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(url, httpMethod, data, headers, hostInfo, credentials,
		logger, callback)</span> </span>{

	hostInfo.port = hostInfo.port || <span class="hljs-number">80</span>;

	<span class="hljs-keyword">var</span> apiRequest, prop, hasErrored;
	<span class="hljs-keyword">var</span> mergedHeaders = createHeaders(hostInfo.host, headers);

	data = prepare(data, credentials.consumerkey);</pre></div>
        
      
        
        <p>Special case for track previews: we explicitly request to be given
the XML response back instead of a redirect to the track download.</p>

        
          <div class='highlight'><pre>	<span class="hljs-keyword">if</span> (url.indexOf(<span class="hljs-string">'track/preview'</span>) &gt;= <span class="hljs-number">0</span>) {
		data.redirect = <span class="hljs-string">"false"</span>;
	}

	<span class="hljs-keyword">if</span> (httpMethod === <span class="hljs-string">'GET'</span>) {
		url = url + <span class="hljs-string">'?'</span> + qs.stringify(data);
	}

	logger.info(util.format(<span class="hljs-string">'%s: http://%s:%s%s'</span>, httpMethod,
		hostInfo.host, hostInfo.port, url));
	logHeaders(logger, mergedHeaders);</pre></div>
        
      
        
        <p>Make the request</p>

        
          <div class='highlight'><pre>	apiRequest = http.request({
		method: httpMethod,</pre></div>
        
      
        
        <p>disable connection pooling to get round node’s unnecessarily low
5 max connections</p>

        
          <div class='highlight'><pre>		agent: <span class="hljs-literal">false</span>,
		hostname: hostInfo.host,</pre></div>
        
      
        
        <p>Force scheme to http for browserify otherwise it will pick up the
scheme from window.location.protocol which is app:// in firefoxos</p>

        
          <div class='highlight'><pre>		scheme: <span class="hljs-string">'http'</span>,</pre></div>
        
      
        
        <p>Set this so browserify doesn’t set it to true on the xhr, which
causes an http status of 0 and empty response text as it forces
the XHR to do a pre-flight access-control check and the API
currently does not set CORS headers.</p>

        
          <div class='highlight'><pre>		withCredentials: <span class="hljs-literal">false</span>,
		path: url,
		port: hostInfo.port,
		headers: mergedHeaders
	}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleResponse</span><span class="hljs-params">(response)</span> </span>{
		<span class="hljs-keyword">var</span> responseBuffer = <span class="hljs-string">''</span>;

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> response.setEncoding === <span class="hljs-string">'function'</span>) {
			response.setEncoding(<span class="hljs-string">"utf8"</span>);
		}

		response.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bufferData</span><span class="hljs-params">(chunk)</span> </span>{
			responseBuffer += chunk;
		});

		response.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endResponse</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">if</span> (+response.statusCode &gt;= <span class="hljs-number">400</span>) {
				<span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> ApiHttpError(
					response.statusCode, responseBuffer));
			}

			<span class="hljs-keyword">if</span> (!hasErrored) {
				<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, responseBuffer, response);
			}
		});
	});

	apiRequest.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logErrorAndCallback</span><span class="hljs-params">(data)</span> </span>{</pre></div>
        
      
        
        <p>Flag that we’ve errored so we don’t call the callback twice
if we get an end event on the response.</p>

        
          <div class='highlight'><pre>		hasErrored = <span class="hljs-literal">true</span>;
		logger.info(<span class="hljs-string">'Error fetching ['</span> + url + <span class="hljs-string">']. Body:\n'</span> + data);

		<span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Error connecting to '</span> + url));
	});

	<span class="hljs-keyword">if</span> (httpMethod === <span class="hljs-string">'GET'</span>) {
		apiRequest.end();
	} <span class="hljs-keyword">else</span> {
		apiRequest.end(data);
	}
}

<span class="hljs-built_in">module</span>.exports.get = get;
<span class="hljs-built_in">module</span>.exports.post = post;
<span class="hljs-built_in">module</span>.exports.createHeaders = createHeaders;
<span class="hljs-built_in">module</span>.exports.prepare = prepare;
<span class="hljs-built_in">module</span>.exports.dispatch = dispatch;
<span class="hljs-built_in">module</span>.exports.dispatchSecure = dispatchSecure;</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
