<!DOCTYPE html>

<html>
<head>
  <title>oauth.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>oauth.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="customconfig.html">
                    customconfig.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="default-action.html">
                    default-action.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="oauth.html">
                    oauth.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="simpleclient.html">
                    simpleclient.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="two-legged.html">
                    two-legged.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="user-authentication.html">
                    user-authentication.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="user-locker.html">
                    user-locker.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="user-management.html">
                    user-management.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="api.html">
                    api.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="cleaners.html">
                    cleaners.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="errors.html">
                    errors.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="helpers.html">
                    helpers.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="oauth.html">
                    oauth.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="parameters.html">
                    parameters.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="request.html">
                    request.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="resource.html">
                    resource.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="responseparser.html">
                    responseparser.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> OAuthClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oauth'</span>).OAuth;
<span class="hljs-keyword">var</span> accessTokenUrl = <span class="hljs-string">'http://api.7digital.com/1.2/oauth/accesstoken'</span>;
<span class="hljs-keyword">var</span> responseParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./responseparser'</span>);</pre></div>
        
      
        
        <p>Creates an OAuth v1 wrapper configured with the supplied key and
secret and the necessary options for authenticating with the
7digital API.</p>
<ul>
<li>@param {String} oauthkey</li>
<li><p>@param {String} oauthsecret</p>
</li>
<li><p>@return {OAuth}</p>
</li>
</ul>

        
          <div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createOAuthWrapper</span><span class="hljs-params">(oauthkey,
	oauthsecret, headers)</span> </span>{

	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OAuthClient(
				<span class="hljs-string">'https://api.7digital.com/1.2/oauth/requesttoken'</span>,
				accessTokenUrl,
				oauthkey, oauthsecret, <span class="hljs-string">'1.0'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'HMAC-SHA1'</span>, <span class="hljs-number">32</span>, headers);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">OAuth</span><span class="hljs-params">(options)</span> </span>{
	<span class="hljs-keyword">this</span>.consumerkey = options.consumerkey;
	<span class="hljs-keyword">this</span>.consumersecret = options.consumersecret;
	<span class="hljs-keyword">this</span>.client = createOAuthWrapper(options.consumerkey,
		options.consumersecret);
}</pre></div>
        
      
        
        <p>Gets a request token from the 7digital API and generates an authorise
url for the user to grant the application access to their locker and
make purchases on their behalf.</p>
<pre><code><span class="hljs-keyword">var</span> api = <span class="hljs-built_in">require</span>(<span class="hljs-string">'7digital-api'</span>).configure({
        consumerkey: <span class="hljs-string">'YOUR_KEY_HERE'</span>,
        consumersecret: <span class="hljs-string">'YOUR_SECRET'</span>,
        defaultParams: {
             country: <span class="hljs-string">'fr'</span>
        }
});
<span class="hljs-keyword">var</span> oAuth = <span class="hljs-keyword">new</span> api.OAuth();
oAuth.getRequestToken(<span class="hljs-string">'http://acme.com/oauth_cb'</span>, authorise);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorise</span><span class="hljs-params">(err, requestToken, requestSecret, authoriseUrl)</span> </span>{
         <span class="hljs-comment">// Get an access token</span>
});
</code></pre><ul>
<li>@param {String} cbUrl</li>
<li>@param {Function} callback</li>
</ul>

        
          <div class='highlight'><pre>OAuth.prototype.getRequestToken = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequestToken</span><span class="hljs-params">(cbUrl, callback)</span> </span>{
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaultParams.country) {
		<span class="hljs-keyword">this</span>.client.getOAuthRequestToken({
			country: <span class="hljs-keyword">this</span>.defaultParams.country
		}, buildAuthoriseUrl.bind(<span class="hljs-keyword">this</span>));
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">this</span>.client.getOAuthRequestToken(buildAuthoriseUrl.bind(<span class="hljs-keyword">this</span>));
	}
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildAuthoriseUrl</span><span class="hljs-params">(err, requestToken, requestSecret, results)</span> </span>{
		<span class="hljs-keyword">var</span> authoriseUrl;

		<span class="hljs-keyword">if</span> (err) {
			callback(err);
			<span class="hljs-keyword">return</span>;
		}

		<span class="hljs-comment">/* jshint validthis: true */</span>
		authoriseUrl = <span class="hljs-string">'https://account.7digital.com/'</span> +
						<span class="hljs-keyword">this</span>.consumerkey + <span class="hljs-string">'/oauth/authorise?'</span> +
					<span class="hljs-string">'oauth_token='</span> + requestToken + <span class="hljs-string">'&amp;oauth_callback='</span> +
					<span class="hljs-built_in">encodeURIComponent</span>(cbUrl);

		<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, requestToken, requestSecret, authoriseUrl);
	}
};</pre></div>
        
      
        
        <p>Authorises a request token from the 7digital API for consumers who have
access to the user management API.  If there is no error the requesttoken
may be used to gain an access token using <code>getAccessToken</code>.</p>
<ul>
<li>@param {Object} requestData</li>
<li>@param {Function} callback</li>
</ul>
<p>The requestData parameter should contain the following</p>
<ul>
<li><code>username</code> the email address of the user</li>
<li><code>password</code> the password for the user’s account</li>
<li><code>token</code> the request token received from <code>getRequestToken</code></li>
</ul>

        
          <div class='highlight'><pre>OAuth.prototype.authoriseRequestToken = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authoriseRequestToken</span><span class="hljs-params">(
	requestData, callback)</span> </span>{

	<span class="hljs-keyword">var</span> url = <span class="hljs-string">'https://api.7digital.com/1.2/oauth/requestToken/authorise?'</span>;
	<span class="hljs-keyword">var</span> fullUrl;

	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.country) {
		requestData.country = <span class="hljs-keyword">this</span>.defaultParams.country;
	}

	fullUrl = url + qs.stringify(requestData);

	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.client.get(fullUrl, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, checkResponse.bind(<span class="hljs-keyword">this</span>));
	<span class="hljs-comment">/* jshint validthis: true */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkResponse</span><span class="hljs-params">(err, data)</span> </span>{
		<span class="hljs-keyword">if</span> (err) {
			<span class="hljs-keyword">return</span> callback(err);
		}

		responseParser.parse(data,
			{ format: <span class="hljs-keyword">this</span>.format, logger: <span class="hljs-keyword">this</span>.logger }, getTokens);
		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTokens</span><span class="hljs-params">(err, tokenResponse)</span> </span>{
			<span class="hljs-keyword">var</span> accessToken, accessSecret;

			<span class="hljs-keyword">if</span> (err) {
				<span class="hljs-keyword">return</span> callback(err);
			}

			<span class="hljs-keyword">return</span> callback();
		}
	}
};</pre></div>
        
      
        
        <p>Gets an access token from the 7digital API for signing requests to
access a user’s 7digital account on their behalf.</p>
<p>You must generate your access token only after the user has authorised
the request token.</p>
<p>You can use this token and secret for signing requests to the 3-legged
OAuth secured API endpoints.</p>
<pre><code><span class="hljs-keyword">var</span> api = <span class="hljs-built_in">require</span>(<span class="hljs-string">'7digital-api'</span>).configure({
        consumerkey: <span class="hljs-string">'YOUR_KEY_HERE'</span>,
        consumersecret: <span class="hljs-string">'YOUR_SECRET'</span>,
        defaultParams: {
            country: <span class="hljs-string">'us'</span>
        }
});
<span class="hljs-keyword">var</span> oAuth = <span class="hljs-keyword">new</span> api.OAuth();
oAuth.getAccessToken({
        requesttoken: <span class="hljs-string">'YOUR_TOKEN_HERE'</span>,
        requestsecret: <span class="hljs-string">'TOKEN_SECRET_HERE'</span>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">accessSignedEndpoints</span><span class="hljs-params">(err, accessToken, accessSecret)</span> </span>{
        <span class="hljs-comment">// Access the user's locker etc</span>
});
</code></pre><ul>
<li>@param {Object} requestData</li>
<li>@param {Function} callback</li>
</ul>
<p>The requestData parameter should contain the following</p>
<ul>
<li><code>requesttoken</code> an authorised OAuth request token</li>
<li><code>requestsecret</code> the corresponding OAuth request secret</li>
</ul>

        
          <div class='highlight'><pre>OAuth.prototype.getAccessToken = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAccessToken</span><span class="hljs-params">(requestData,
	callback)</span> </span>{

	<span class="hljs-keyword">var</span> extraParams = <span class="hljs-literal">null</span>;

	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaultParams.country) {
		extraParams = { country: <span class="hljs-keyword">this</span>.defaultParams.country };
	}</pre></div>
        
      
        
        <p>This must be done manually rather than using the wrapper as there is
no means of supplying the extra parameter via getOAuthAccessToken</p>

        
          <div class='highlight'><pre>	<span class="hljs-keyword">this</span>.client._performSecureRequest(requestData.requesttoken,
		requestData.requestsecret, <span class="hljs-string">'POST'</span>, accessTokenUrl, extraParams, <span class="hljs-literal">null</span>,
		<span class="hljs-literal">null</span>, checkResponse.bind(<span class="hljs-keyword">this</span>));
	<span class="hljs-comment">/* jshint validthis: true */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkResponse</span><span class="hljs-params">(err, data, response)</span> </span>{
		<span class="hljs-keyword">var</span> results, accessToken, accessSecret;

		<span class="hljs-keyword">if</span> (err) {
			<span class="hljs-keyword">return</span> callback(err);
		}</pre></div>
        
      
        
        <p>Check if we got a for url encoded response</p>

        
          <div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/oauth_token/</span>.test(data)) {
			results = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>).parse(data);
			accessToken= results[<span class="hljs-string">'oauth_token'</span>];
			accessSecret = results[<span class="hljs-string">'oauth_token_secret'</span>];

			<span class="hljs-keyword">delete</span> results[<span class="hljs-string">'oauth_token'</span>];
			<span class="hljs-keyword">delete</span> results[<span class="hljs-string">'oauth_token_secret'</span>];

			<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, accessToken, accessSecret);
		}</pre></div>
        
      
        
        <p>We didn’t so parse the body as an XML response</p>

        
          <div class='highlight'><pre>		responseParser.parse(data,
			{ format: <span class="hljs-keyword">this</span>.format, logger: <span class="hljs-keyword">this</span>.logger }, getTokens);
		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTokens</span><span class="hljs-params">(err, tokenResponse)</span> </span>{
			<span class="hljs-keyword">var</span> accessToken, accessSecret;

			<span class="hljs-keyword">if</span> (err) {
				<span class="hljs-keyword">return</span> callback(err);
			}

			accessToken = tokenResponse.oauth_access_token.oauth_token;
			accessSecret = tokenResponse.oauth_access_token.oauth_token_secret;

			<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, accessToken, accessSecret);
		}
   }
};</pre></div>
        
      
        
        <p>Allows you to sign GET requests manually.  The common case for this
is to access the media delivery API where you make a signed request
and receive the media data directly in the reponse.</p>
<ul>
<li>@param {String} <code>url</code> The url to sign</li>
<li>@param {Object} <code>parameters</code> Any query parameters.</li>
</ul>

        
          <div class='highlight'><pre>OAuth.prototype.sign = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sign</span><span class="hljs-params">(url, parameters)</span> </span>{
	<span class="hljs-keyword">var</span> orderedParams, accesstoken, accesssecret;
	<span class="hljs-keyword">var</span> query = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">var</span> parsedUrl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>).parse(url, <span class="hljs-literal">false</span>);

	parameters = parameters || {};
	_.defaults(parameters, <span class="hljs-keyword">this</span>.defaultParams);

	accesstoken = parameters.accesstoken || <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">delete</span> parameters.accesstoken;
	accesssecret = parameters.accesssecret || <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">delete</span> parameters.accesssecret;

	orderedParams = <span class="hljs-keyword">this</span>.client._prepareParameters(accesstoken, accesssecret,
		<span class="hljs-string">'GET'</span>, url, parameters);

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; orderedParams.length; i++) {
		query += orderedParams[i][<span class="hljs-number">0</span>] + <span class="hljs-string">'='</span> +
			<span class="hljs-keyword">this</span>.client._encodeData(orderedParams[i][<span class="hljs-number">1</span>]) + <span class="hljs-string">'&amp;'</span>;
	}
	query = query.substring(<span class="hljs-number">0</span>, query.length - <span class="hljs-number">1</span>);

	<span class="hljs-keyword">return</span> parsedUrl.protocol + <span class="hljs-string">'//'</span>+ parsedUrl.host + parsedUrl.pathname +
		<span class="hljs-string">'?'</span> + query;
};

<span class="hljs-built_in">module</span>.exports = exports = {
	createOAuthWrapper: createOAuthWrapper,
	OAuth: OAuth
};</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
